<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="ttl2jsonld.js"></script>  <!-- from: https://github.com/frogcat/ttl2jsonld -->
	<script src="libSOH.js"></script>
	<!--script type="text/javascript" src="libde265/libde265.js"></script-->

	<script>
"use strict"

function IncludeScript(url, late)   //https://stackoverflow.com/questions/950087/how-do-i-include-a-javascript-file-in-another-javascript-file
{
	var script = document.createElement("script");  // create a script DOM node

	if (late)
	{
		script.setAttributeNode(document.createAttribute("async"));
		script.setAttributeNode(document.createAttribute("defer"));
	}
	script.src = url;  // set its src to the provided URL

	document.head.appendChild(script);  // add it to the end of the head section of the page (could change 'head' to 'body' to add it to the end of the body section instead). 
}
IncludeScript("libde265/libde265.js");

function readSOHForm(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages){
	readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages);
	return false;
}

async function readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages){
	var url=document.getElementById(divIdURL).value;
	var fileInfo=await readSOHBoxDumpURL(url, parseInt(document.getElementById(divIdLimit).value), divIdBoxes, showBoxes);
	if (!fileInfo)
		return;
	fileInfo.brand=await readSOHFtypBoxURL(url, fileInfo);
	if (fileInfo.brand)
		showBoxes(fileInfo, divIdBoxes)
	if (divIdGroups)
		fileInfo.groups=await readSOHGroupsDumpURL(url, fileInfo, divIdGroups, showGroups);
	if (divIdItems)
		fileInfo.items=await readSOHItemsDumpURL(url, document.getElementById(divIdSidecarURL).value, fileInfo, divIdItems, showItems);
	if (divIdImages)
		showSOHImagesItems(url, fileInfo, divIdImages);
	return fileInfo;
}


function dataViewToHexa(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="", h;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
	{
		h=dataView.getUint8(i).toString(16).toUpperCase();
		s+=((h.length==1) ? "0"+h : h) +" ";
	}
	return s;
}

function dataViewToChar(dataView, limit)
{
	if (!dataView)
		return "";

	var len=dataView.byteLength, s="", c;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++) {
		if (dataView.getUint8(i)<32)
			c="Â·";
		else {
			c=String.fromCharCode(dataView.getUint8(i));
			if (c=='<')
				c="&lt;";
			else if (c=='&')
				c="&amp;";
		}
		s+=c;
	}
	return s;
}

function dataViewToDeci(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="";

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
		s+=dataView.getUint8(i).toString()+" ";

	return s;
}

async function showBoxes(fileInfo, divId) {
	var array=fileInfo.boxes, brand=fileInfo.brand, s="";
	if (brand) {
		s+="<H3>Brand information</H3>";
		s+="<i>Major grand</i>: <b>" + brand.majorBrand + "</b> version " + brand.minorVersion + "<br>";
		if (brand.compatibleBrands) {
			s+="<i>Compatible brands</i>:<br><ul>";
			for (var i=0; i<brand.compatibleBrands.length; i++) {
				s+="<li><b>"+brand.compatibleBrands[i]+"</b>";
				for (var j=0; j<brandSOHMeaning.length; j++) {
					if (brand.compatibleBrands[i]==brandSOHMeaning[j].brand) {
						s+=" ("+ brandSOHMeaning[j].meaning +")";
						break;
					}
				}
				s+="<br>";
			}
			s+="</ul>";
		}
	}
	if (array) {
		s+="<H3>Boxes information</H3>";
		s+="<table border=1><tr><th>Size</th><th>Type</th><th>Data (String)</th><th>Data (Number)</th><th>Data (Hex)</th></tr>";
		for (var i=0; i<array.length; i++)
			s+="<tr><td>" + array[i].size + "</td><td>" + array[i].type + "</td><td>" + dataViewToChar(array[i].dataView) + "</td><td>" + dataViewToDeci(array[i].dataView) + "</td><td style='font-family: monospace;'>" + dataViewToHexa(array[i].dataView) + "</td></tr>";
		s+="</table>";
	}
	document.getElementById(divId).innerHTML=s;
}

async function showItems(items, divId) {
	var s="<H3>Items information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Name</th><th>Type</th><th>Byte ranges</th><th>Witdh & height</th><th>Bits per channel</th><th>Pyramid id</th><th>Size multiple</th><th>Is tile?</th><th>Tile width & height</th><th>Matrix width & height</th><th>N of tiles</th><th>Byte range of first tiles from the 'mdat' start</th><th>Content ID</th><th>WKT</th></tr>";
	for (var i=0; i<items.length; i++) {
		s+="<tr><td>" + items[i].itemId + "</td><td>" + items[i].itemName + "</td><td>" + (items[i].itemType=='mime' ? items[i].contentType : items[i].itemType=='uri ' ? items[i].itemUriType : items[i].itemType) + "</td><td>";
		if (items[i].extents) {
			for (var j=0; j<items[i].extents.length; j++) {
				s+="[" + items[i].extents[j].extentOffset + "-" + (items[i].extents[j].extentOffset+items[i].extents[j].extentLength-1) + "]";
			}
		}
		s+="</td><td>";
		if (typeof items[i].imageWidth !== "undefined" && typeof items[i].imageHeight !== "undefined") {
			s+=items[i].imageWidth + ", " + items[i].imageHeight;
		}
		s+="</td><td>";
		if (items[i].bitsPerChannels) {
			s+="[";
			for (var j=0; j<items[i].bitsPerChannels.length; j++) {
				s+=items[i].bitsPerChannels[j];
				if (j+1<items[i].bitsPerChannels.length)
					s+=",";
			}
			s+="]";
		}
		s+="</td><td>";
		if (typeof items[i].pyramidId !== "undefined")
			s+=items[i].pyramidId;
		s+="</td><td>";
		if (typeof items[i].sizeMultiple !== "undefined")
			s+=items[i].sizeMultiple;
		s+="</td><td>";
		s+=items[i].isTile ? "yes" : "";
		s+="</td><td>";
		if (typeof items[i].tileWidth !== "undefined" && typeof items[i].tileHeight !== "undefined") {
			s+=items[i].tileWidth + ", " + items[i].tileHeight;
		}
		s+="</td><td>";
		if (typeof items[i].matrixWidth !== "undefined" && typeof items[i].matrixHeight !== "undefined") {
			s+=items[i].matrixWidth + ", " + items[i].matrixHeight;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+=items[i].tiles.length;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+="[";
			for (var j=0; j<5 && j<items[i].tiles.length; j++) {
				s+="[" + items[i].tiles[j].offset + "-" + (items[i].tiles[j].offset+items[i].tiles[j].size-1) + "]";
				if (j+1<5 && j+1<items[i].tiles.length)
					s+=",";
				else if (j+1<items[i].tiles.length)
					s+=",...";
			}
			s+="]";
		}
		s+="</td><td>";
		if (items[i].contentId)
			s+=items[i].contentId;
		s+="</td><td>";
		if (items[i].wkt)
			s+=items[i].wkt;
		s+="</td></tr>";
	}
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

async function showGroups(groups, divId) {
	var s="<H3>Groups information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Type</th><th>Tile width</th><th>Tile height</th><th>Tile matrices</th><th>Levels</th></tr>";
	for (var i=0; i<groups.length; i++) {
		s+="<tr><td>" + groups[i].groupId + "</td><td>" + groups[i].type + "</td><td>";
		if (groups[i].tileWidth)
			s+=groups[i].tileWidth;
		s+="</td><td>";
		if (groups[i].tileHeight)
			s+=groups[i].tileHeight;
		s+="</td><td>";
		if (groups[i].entities) {
			s+=groups[i].entities.length;
			s+="</td><td><table border=1><tr><th>Size multiple</th><th>Matrix widths</th><th>Matrix heights</th></tr>"
			for (var j=0; j<groups[i].entities.length; j++) {
				s+="<tr><td>"+
					groups[i].entities[j].sizeMultiple+"</td><td>"+
					groups[i].entities[j].matrixWidth+"</td><td>"+
					groups[i].entities[j].matrixHeight+"</td></tr>";
			}
			s+="</table>"
		} else
			s+="</td><td>";
		s+="</td></tr>";
	}		
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

function preparecanvasSOHImage(canvasId, width, height) {
	var s="";
	//if (profile=="rgb3") {  //RGB 24 bits packed {'rgb3', 3, [{4,7},{5,7},{6,7}], 0, 1}
		s+="<canvas id=\""+canvasId+"\" width=\""+width+"px\" height=\""+height+"px\"></canvas>";
	//}
	return s;
}

function showSOHImage(data, canvasId, width, height) {

	var canvas = document.getElementById(canvasId);
	var ctx = canvas.getContext('2d');
	ctx.clearRect( 0, 0, ctx.canvas.width, ctx.canvas.height);
	var imgData=ctx.createImageData(width, height);
	imgData.data.set(data);
	ctx.putImageData(imgData, 0, 0);
}

async function getSOHImage(url, item, offsetMdat, iTile, jTile){

	if(!item)
		return null;
	if (item.tileWidth && item.tileHeight)
		return await getURLBuffer(url, offsetMdat+item.tiles[jTile*item.matrixWidth+iTile].offset, offsetMdat+item.tiles[jTile*item.matrixWidth+iTile].offset+item.tiles[jTile*item.matrixWidth+iTile].size-1);
	return await getURLBuffer(url, item.extents[0].extentOffset, item.extents[0].extentOffset+item.extents[0].extentLength-1);
}

async function getAndshowSOHUnciImage(url, item, offsetMdat, iTile, jTile)
{
	var arrayBuffer=null, itemType, uncompressProfile, height, width, canvasId;
	if (item.tileWidth && item.tileHeight) {
		itemType=item.itemTypeTile;
		uncompressProfile=item.uncompressProfileTile;
		width=item.tileWidth;
		height=item.tileHeight;
		canvasId=item.itemId + "_" + jTile + "_" + iTile;		
	}
	else {
		itemType=item.itemType;
		uncompressProfile=item.uncompressProfile;
		width=item.imageWidth;
		height=item.imageHeight;
		canvasId=item.itemId;
	}
	if(itemType!='unci' || uncompressProfile!="rgb3")   //RGB 24 bits packed {'rgb3', 3, [{4,7},{5,7},{6,7}], 0, 1}
		return;	
	arrayBuffer=await getSOHImage(url, item, offsetMdat, iTile, jTile);
	if(!arrayBuffer)
		return;
	
	var dataView=new DataView(arrayBuffer), data=[];

	for (var offset=0, j=0; j<height; j++) {
		for (var i=0; i<width; i++, offset+=3)
			data.push(dataView.getUint8(offset), dataView.getUint8(offset+1), dataView.getUint8(offset+2), 255);
	}
	showSOHImage(data, canvasId, width, height);
	return;
}

function getAndConvertImageYUV2RGB(image){

	var h = image.get_height(), w=image.get_width();

	var canvas = document.getElementById(image.decoder.canvasId);
	var ctx = canvas.getContext('2d');
	ctx.clearRect( 0, 0, h, w);
	var imgData=ctx.createImageData(w, h);
	var data = imgData.data;
	for (var i=0; i<w*h; i++) {
		data[i*4+3] = 255;
	}
	image.ImageData=imgData;
    image.display(image.ImageData, function(display_image_data) {
        ctx.putImageData(display_image_data, 0, 0);
    });
	return image.ImageData.data;
}

async function getAndshowSOHH265Image(url, item, offsetMdat, iTile, jTile, itemsArray){
var arrayBuffer=null, itemType, height, width, canvasId, tileItem;

	if(!item)
		return null;
	if (item.tileWidth && item.tileHeight){
		itemType=item.itemTypeTile;
		width=item.tileWidth;
		height=item.tileHeight;
		canvasId=item.itemId + "_" + jTile + "_" + iTile;
		if(itemsArray && typeof item.tiles[jTile*item.matrixWidth+iTile].itemId !== "undefined"){
			var indexItem=getIndexSOHItemID(itemsArray, item.tiles[jTile*item.matrixWidth+iTile].itemId)
			if(indexItem!=-1)
				tileItem=itemsArray[indexItem];
			else
				tileItem=null;
		}
		else tileItem=null;
	}
	else{
		itemType=item.itemType;
		width=item.imageWidth;
		height=item.imageHeight;
		canvasId=item.itemId;
		tileItem=null;
	}
	if(itemType!='hvc1')
		return;
	arrayBuffer=await getSOHImage(url, item, offsetMdat, iTile, jTile);
	if(!arrayBuffer)
		return;

	var dataView=new DataView(arrayBuffer);

	var decoder = new libde265.Decoder(), error;
	decoder.canvasId=canvasId;
	decoder.set_image_callback(function(image) {
		decoder.data=getAndConvertImageYUV2RGB(image);
		image.free();
	});		
	var naluArrays= (item.naluArrays) ? item.naluArrays : (tileItem ? tileItem.naluArrays : null);
	if(naluArrays)
	{
		for (var i_array=0; i_array<naluArrays.length; i_array++)
		{
			for (var i_nalu_unit=0; i_nalu_unit<naluArrays[i_array].data.length; i_nalu_unit++)
			{
				error=decoder.push_NAL(naluArrays[i_array].data[i_nalu_unit]);
				if(error)
					console.log("error" + error);
			}
		}
	}
	var offset=0, data_length, data_pack, more;
	while(offset<dataView.byteLength)
	{
		data_length=dataView.getUint32(offset);
		data_pack=[];
		offset+=4;
		for (var z=0; z<data_length; z++) {
			data_pack[z]=dataView.getUint8(offset);
			offset++;
		}	
		error=decoder.push_NAL(data_pack);
		if(error)
			console.log("error" + error);
	}
	error=decoder.push_end_of_frame();
	if(error)
		console.log("error" + error);

	decoder.decode();	
	decoder.free();
	return;
}


function isSOHImageTypeSupported(itemType, uncompressProfile)
{
	//if( itemType=='j2k1' || itemType=='avc1' || itemType=='jpeg')  // codes supported for Still Imagery	
	if((itemType=='unci' && uncompressProfile=="rgb3") || itemType=='hvc1')
		return true;
	return false;	
}

async function showSOHImagesItems(url, fileInfo, divId) {
	var item, s="", arrayBuffer;

	var mdat=getIndexSOHBoxType(fileInfo.boxes, "mdat");
	if (mdat==-1)
		return;
	var offsetMdat=fileInfo.boxes[mdat].start;

	var s="<H3>Item images</H3>";
	for (var a=0; a<fileInfo.items.length; a++) {
		item=fileInfo.items[a];
		if (!item.isTile) {
			if (item.tileWidth && item.tileHeight) { //is a grid or tili
				s+="<table>";
				for (var j=0; j<item.matrixHeight; j++) {
					s+="<tr>";
					for (var i=0; i<item.matrixWidth; i++) {
						if(isSOHImageTypeSupported(item.itemTypeTile, item.uncompressProfileTile))
						{
							s+="<td>Tile (" + j + "," + i + ")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
								preparecanvasSOHImage(item.itemId + "_" + j + "_" + i, item.tileWidth, item.tileHeight)+
								"</td>";
						}
					}
					s+="</tr>";
				}
				s+="</table>";
			} else {
				if(isSOHImageTypeSupported(item.itemType, item.uncompressProfile))
					s+=preparecanvasSOHImage(item.itemId,item.imageWidth, item.imageHeight);
			}
		}
	}
	document.getElementById(divId).innerHTML=s;
	for (var a=0; a<fileInfo.items.length; a++) {
		item=fileInfo.items[a];
		if (!item.isTile) {
			if (item.tileWidth && item.tileHeight) { //is a grid or tili
				for (var j=0; j<item.matrixHeight; j++) {
					for (var i=0; i<item.matrixWidth; i++) {
						if(item.itemTypeTile=='unci' && item.uncompressProfileTile=="rgb3")
							getAndshowSOHUnciImage(url, item, offsetMdat, i, j);
						else if(item.itemTypeTile=='hvc1')	
							getAndshowSOHH265Image(url, item, offsetMdat, i, j, fileInfo.items);
						
					}
				}
			} else {
				if(item.itemType=='unci' && item.uncompressProfile=="rgb3")
					getAndshowSOHUnciImage(url, item, offsetMdat);
				else if(item.itemType=='hvc1')	
					getAndshowSOHH265Image(url, item, offsetMdat);				
			}
		}
	}
}

	</script>
</head>

<body>
	<form>
	<!--HEIF URL: <input id="heifURL" value="tb21_4x4_grid.heif"/> sidecar: <input id="sidecarURL" value="tb21_4x4_grid.ttl"/>-->
	<!--HEIF URL: <input id="heifURL" value="rotterdam.avif"/> sidecar: <input id="sidecarURL" value=""/>-->
	<!--HEIF URL: <input id="heifURL" value="tb21-2x4-uncompressed-internal-rdf.heif"/> sidecar: <input id="sidecarURL" value=""/>-->
	HEIF URL: <input id="heifURL" value="tb21-single-image-hevc-internal-rdf.heif"/> sidecar: <input id="sidecarURL" value=""/>
	<button onClick='return readSOHForm("heifURL", "sidecarURL", "limit", "heifBoxes", "heifItems", "heifGroups", "images");'>read</button>
	Data max length: <input id="limit" value="20"/><br>
	<div id="heifBoxes"></div>
	<div id="heifItems"></div>
	<div id="heifGroups"></div>
	<div id="images"></div>
	</form>
</body>