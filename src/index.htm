<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="ttl2jsonld.js"></script>  <!-- from: https://github.com/frogcat/ttl2jsonld -->
	<script src="libSOH.js"></script>

	<script>
"use strict"

function readSOHForm(divIdURL, divIdSidecarURL, divIdLimit, divIdBox, divIdItem){
	readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBox, divIdItem);
	return false;
}

async function readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBox, divIdItem){
	var fileInfo=await readSOHBoxDumpURL(document.getElementById(divIdURL).value, parseInt(document.getElementById(divIdLimit).value), divIdBox, showBox);
	if (divIdItem)
		fileInfo.items=await readSOHItemsDumpURL(document.getElementById(divIdURL).value, document.getElementById(divIdSidecarURL).value, fileInfo, divIdItem, showItem);
	return fileInfo;
}


function dataViewToHexa(dataView, limit)
{
var len=dataView.byteLength, s="", h;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
	{
		h=dataView.getUint8(i).toString(16).toUpperCase();
		s+=((h.length==1) ? "0"+h : h) +" ";
	}
	return s;
}

function dataViewToChar(dataView, limit)
{
var len=dataView.byteLength, s="", c;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++) {
		if (dataView.getUint8(i)<32)
			c="Â·";
		else {
			c=String.fromCharCode(dataView.getUint8(i));
			if (c=='<')
				c="&lt;";
			else if (c=='&')
				c="&amp;";
		}
		s+=c;
	}
	return s;
}

function dataViewToDeci(dataView, limit)
{
var len=dataView.byteLength, s="";

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
		s+=dataView.getUint8(i).toString()+" ";

	return s;
}

async function showBox(array, divShow) {
	var s="<table border=1><tr><th>Size</th><th>Type</th><th>Data (String)</th><th>Data (Number)</th><th>Data (Hex)</th></tr>";
	for (var i=0; i<array.length; i++)
		s+="<tr><td>" + array[i].size + "</td><td>" + array[i].type + "</td><td>" + dataViewToChar(array[i].dataView) + "</td><td>" + dataViewToDeci(array[i].dataView) + "</td><td style='font-family: monospace;'>" + dataViewToHexa(array[i].dataView) + "</td></tr>";
	s+="</table>";
	document.getElementById(divShow).innerHTML=s;
}

async function showItem(items, divItem) {
	var s="<table border=1><tr><th>Id</th><th>Name</th><th>Type</th><th>Byte ranges</th><th>Witdh & height</th><th>Bits per channel</th><th>Content ID</th><th>WKT</th></tr>";
	for (var i=0; i<items.length; i++) {
		s+="<tr><td>" + items[i].itemId + "</td><td>" + items[i].itemName + "</td><td>" + (items[i].itemType=='mime' ? items[i].contentType : items[i].itemType=='uri ' ? items[i].itemUriType : items[i].itemType) + "</td><td>";
		if (items[i].extents) {
			for (var j=0; j<items[i].extents.length; j++) {
				s+="[" + items[i].extents[j].extentOffset + "-" + (items[i].extents[j].extentOffset+items[i].extents[j].extentLength-1) + "]";
			}
		}
		s+="</td><td>";
		if (typeof items[i].imageWidth !== "undefined" && typeof items[i].imageHeight !== "undefined") {
			s+=items[i].imageWidth + ", " + items[i].imageHeight;
		}
		s+="</td><td>";
		if (items[i].bitsPerChannels) {
			s+="[";
			for (var j=0; j<items[i].bitsPerChannels.length; j++) {
				s+=items[i].bitsPerChannels[j];
				if (j+1<items[i].bitsPerChannels.length)
					s+=",";
			}
			s+="]";
		}
		s+="</td><td>";
		if (items[i].contentId)
			s+=items[i].contentId;
		s+="</td><td>";
		if (items[i].wkt)
			s+=items[i].wkt;
		s+="</td></tr>";
	}
	s+="</table>";
	document.getElementById(divItem).innerHTML=s;
}

	</script>
</head>

<body>
	<form>
	HEIF URL: <input id="heifURL" value="tb21_4x4_grid.heif"/> sidecar: <input id="sidecarURL" value="tb21_4x4_grid.ttl"/>
	<button onClick='return readSOHForm("heifURL", "sidecarURL", "limit", "heifBox", "heifItem");'>read</button>
	Data max length: <input id="limit" value="20"/><br>
	<div id="heifBox"></div>
	<div id="heifItem"></div>
	</form>
</body>