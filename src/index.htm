<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="ttl2jsonld.js"></script>  <!-- from: https://github.com/frogcat/ttl2jsonld -->
	<script src="libSOH.js"></script>

	<script>
"use strict"

function readSOHForm(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups){
	readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups);
	return false;
}

async function readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups){
	var url=document.getElementById(divIdURL).value;
	var fileInfo=await readSOHBoxDumpURL(url, parseInt(document.getElementById(divIdLimit).value), divIdBoxes, showBoxes);
	if (!fileInfo)
		return;
	fileInfo.brand=await readSOHFtypBoxURL(url, fileInfo);
	if (fileInfo.brand)
		showBoxes(fileInfo, divIdBoxes)
	if (divIdGroups)
		fileInfo.groups=await readSOHGroupsDumpURL(url, fileInfo, divIdGroups, showGroups);
	if (divIdItems)
		fileInfo.items=await readSOHItemsDumpURL(url, document.getElementById(divIdSidecarURL).value, fileInfo, divIdItems, showItems);
	return fileInfo;
}


function dataViewToHexa(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="", h;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
	{
		h=dataView.getUint8(i).toString(16).toUpperCase();
		s+=((h.length==1) ? "0"+h : h) +" ";
	}
	return s;
}

function dataViewToChar(dataView, limit)
{
	if (!dataView)
		return "";

	var len=dataView.byteLength, s="", c;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++) {
		if (dataView.getUint8(i)<32)
			c="Â·";
		else {
			c=String.fromCharCode(dataView.getUint8(i));
			if (c=='<')
				c="&lt;";
			else if (c=='&')
				c="&amp;";
		}
		s+=c;
	}
	return s;
}

function dataViewToDeci(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="";

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
		s+=dataView.getUint8(i).toString()+" ";

	return s;
}

async function showBoxes(fileInfo, divId) {
	var array=fileInfo.boxes, brand=fileInfo.brand, s="";
	if (brand) {
		s+="<H3>Brand information</H3>";
		s+=brand.majorBrand + ", " + brand.minorVersion;
		if (brand.compatibleBrands) {
			s+=", [";
			for (var i=0; i<brand.compatibleBrands.length; i++) {
				s+=brand.compatibleBrands[i];
				if (i+1<brand.compatibleBrands.length)
					s+=", ";
			}
			s+="]";
		}
	}
	if (array) {
		s+="<H3>Boxes information</H3>";
		s+="<table border=1><tr><th>Size</th><th>Type</th><th>Data (String)</th><th>Data (Number)</th><th>Data (Hex)</th></tr>";
		for (var i=0; i<array.length; i++)
			s+="<tr><td>" + array[i].size + "</td><td>" + array[i].type + "</td><td>" + dataViewToChar(array[i].dataView) + "</td><td>" + dataViewToDeci(array[i].dataView) + "</td><td style='font-family: monospace;'>" + dataViewToHexa(array[i].dataView) + "</td></tr>";
		s+="</table>";
	}
	document.getElementById(divId).innerHTML=s;
}

async function showItems(items, divId) {
	var s="<H3>Items information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Name</th><th>Type</th><th>Byte ranges</th><th>Witdh & height</th><th>Bits per channel</th><th>Pyramid id</th><th>Size multiple</th><th>Is tile?</th><th>Tile width & height</th><th>Matrix width & height</th><th>N of tiles</th><th>Byte range of first tiles from the 'mdat' start</th><th>Content ID</th><th>WKT</th></tr>";
	for (var i=0; i<items.length; i++) {
		s+="<tr><td>" + items[i].itemId + "</td><td>" + items[i].itemName + "</td><td>" + (items[i].itemType=='mime' ? items[i].contentType : items[i].itemType=='uri ' ? items[i].itemUriType : items[i].itemType) + "</td><td>";
		if (items[i].extents) {
			for (var j=0; j<items[i].extents.length; j++) {
				s+="[" + items[i].extents[j].extentOffset + "-" + (items[i].extents[j].extentOffset+items[i].extents[j].extentLength-1) + "]";
			}
		}
		s+="</td><td>";
		if (typeof items[i].imageWidth !== "undefined" && typeof items[i].imageHeight !== "undefined") {
			s+=items[i].imageWidth + ", " + items[i].imageHeight;
		}
		s+="</td><td>";
		if (items[i].bitsPerChannels) {
			s+="[";
			for (var j=0; j<items[i].bitsPerChannels.length; j++) {
				s+=items[i].bitsPerChannels[j];
				if (j+1<items[i].bitsPerChannels.length)
					s+=",";
			}
			s+="]";
		}
		s+="</td><td>";
		if (typeof items[i].pyramidId !== "undefined")
			s+=items[i].pyramidId;
		s+="</td><td>";
		if (typeof items[i].sizeMultiple !== "undefined")
			s+=items[i].sizeMultiple;
		s+="</td><td>";
		s+=items[i].isTile ? "yes" : "";
		s+="</td><td>";
		if (typeof items[i].tileWidth !== "undefined" && typeof items[i].tileHeight !== "undefined") {
			s+=items[i].tileWidth + ", " + items[i].tileHeight;
		}
		s+="</td><td>";
		if (typeof items[i].matrixWidth !== "undefined" && typeof items[i].matrixHeight !== "undefined") {
			s+=items[i].matrixWidth + ", " + items[i].matrixHeight;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+=items[i].tiles.length;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+="[";
			for (var j=0; j<5 && j<items[i].tiles.length; j++) {
				s+="[" + items[i].tiles[j].offset + "-" + (items[i].tiles[j].offset+items[i].tiles[j].size-1) + "]";
				if (j+1<5 && j+1<items[i].tiles.length)
					s+=",";
				else if (j+1<items[i].tiles.length)
					s+=",...";
			}
			s+="]";
		}
		s+="</td><td>";
		if (items[i].contentId)
			s+=items[i].contentId;
		s+="</td><td>";
		if (items[i].wkt)
			s+=items[i].wkt;
		s+="</td></tr>";
	}
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

async function showGroups(groups, divId) {
	var s="<H3>Groups information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Type</th><th>Tile width</th><th>Tile height</th><th>Tile matrices</th><th>Levels</th></tr>";
	for (var i=0; i<groups.length; i++) {
		s+="<tr><td>" + groups[i].groupId + "</td><td>" + groups[i].type + "</td><td>";
		if (groups[i].tileWidth)
			s+=groups[i].tileWidth;
		s+="</td><td>";
		if (groups[i].tileHeight)
			s+=groups[i].tileHeight;
		s+="</td><td>";
		if (groups[i].entities) {
			s+=groups[i].entities.length;
			s+="</td><td><table border=1><tr><th>Size multiple</th><th>Matrix widths</th><th>Matrix heights</th></tr>"
			for (var j=0; j<groups[i].entities.length; j++) {
				s+="<tr><td>"+
					groups[i].entities[j].sizeMultiple+"</td><td>"+
					groups[i].entities[j].matrixWidth+"</td><td>"+
					groups[i].entities[j].matrixHeight+"</td></tr>";
			}
			s+="</table>"
		} else
			s+="</td><td>";
		s+="</td></tr>";
	}		
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

	</script>
</head>

<body>
	<form>
	HEIF URL: <input id="heifURL" value="tb21_4x4_grid.heif"/> sidecar: <input id="sidecarURL" value="tb21_4x4_grid.ttl"/>
	<!--HEIF URL: <input id="heifURL" value="rotterdam.avif"/> sidecar: <input id="sidecarURL" value=""/>-->
	<button onClick='return readSOHForm("heifURL", "sidecarURL", "limit", "heifBoxes", "heifItems", "heifGroups");'>read</button>
	Data max length: <input id="limit" value="20"/><br>
	<div id="heifBoxes"></div>
	<div id="heifItems"></div>
	<div id="heifGroups"></div>
	</form>
</body>