<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="ttl2jsonld.js"></script>  <!-- from: https://github.com/frogcat/ttl2jsonld -->
	<script src="libSOH.js"></script>

	<script>
"use strict"

function readSOHForm(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages){
	readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages);
	return false;
}

async function readSOHFormAsync(divIdURL, divIdSidecarURL, divIdLimit, divIdBoxes, divIdItems, divIdGroups, divIdImages){
	var url=document.getElementById(divIdURL).value;
	var fileInfo=await readSOHBoxDumpURL(url, parseInt(document.getElementById(divIdLimit).value), divIdBoxes, showBoxes);
	if (!fileInfo)
		return;
	fileInfo.brand=await readSOHFtypBoxURL(url, fileInfo);
	if (fileInfo.brand)
		showBoxes(fileInfo, divIdBoxes)
	if (divIdGroups)
		fileInfo.groups=await readSOHGroupsDumpURL(url, fileInfo, divIdGroups, showGroups);
	if (divIdItems)
		fileInfo.items=await readSOHItemsDumpURL(url, document.getElementById(divIdSidecarURL).value, fileInfo, divIdItems, showItems);
	if (divIdImages)
		showSOHImagesItems(url, fileInfo, divIdImages);
	return fileInfo;
}


function dataViewToHexa(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="", h;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
	{
		h=dataView.getUint8(i).toString(16).toUpperCase();
		s+=((h.length==1) ? "0"+h : h) +" ";
	}
	return s;
}

function dataViewToChar(dataView, limit)
{
	if (!dataView)
		return "";

	var len=dataView.byteLength, s="", c;

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++) {
		if (dataView.getUint8(i)<32)
			c="Â·";
		else {
			c=String.fromCharCode(dataView.getUint8(i));
			if (c=='<')
				c="&lt;";
			else if (c=='&')
				c="&amp;";
		}
		s+=c;
	}
	return s;
}

function dataViewToDeci(dataView, limit)
{
	if (!dataView)
		return "";
	var len=dataView.byteLength, s="";

	if (limit && len>limit) len=limit;
	for(var i=0; i<len; i++)
		s+=dataView.getUint8(i).toString()+" ";

	return s;
}

async function showBoxes(fileInfo, divId) {
	var array=fileInfo.boxes, brand=fileInfo.brand, s="";
	if (brand) {
		s+="<H3>Brand information</H3>";
		s+="<i>Major grand</i>: <b>" + brand.majorBrand + "</b> version " + brand.minorVersion + "<br>";
		if (brand.compatibleBrands) {
			s+="<i>Compatible brands</i>:<br><ul>";
			for (var i=0; i<brand.compatibleBrands.length; i++) {
				s+="<li><b>"+brand.compatibleBrands[i]+"</b>";
				for (var j=0; j<brandSOHMeaning.length; j++) {
					if (brand.compatibleBrands[i]==brandSOHMeaning[j].brand) {
						s+=" ("+ brandSOHMeaning[j].meaning +")";
						break;
					}
				}
				s+="<br>";
			}
			s+="</ul>";
		}
	}
	if (array) {
		s+="<H3>Boxes information</H3>";
		s+="<table border=1><tr><th>Size</th><th>Type</th><th>Data (String)</th><th>Data (Number)</th><th>Data (Hex)</th></tr>";
		for (var i=0; i<array.length; i++)
			s+="<tr><td>" + array[i].size + "</td><td>" + array[i].type + "</td><td>" + dataViewToChar(array[i].dataView) + "</td><td>" + dataViewToDeci(array[i].dataView) + "</td><td style='font-family: monospace;'>" + dataViewToHexa(array[i].dataView) + "</td></tr>";
		s+="</table>";
	}
	document.getElementById(divId).innerHTML=s;
}

async function showItems(items, divId) {
	var s="<H3>Items information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Name</th><th>Type</th><th>Byte ranges</th><th>Witdh & height</th><th>Bits per channel</th><th>Pyramid id</th><th>Size multiple</th><th>Is tile?</th><th>Tile width & height</th><th>Matrix width & height</th><th>N of tiles</th><th>Byte range of first tiles from the 'mdat' start</th><th>Content ID</th><th>WKT</th></tr>";
	for (var i=0; i<items.length; i++) {
		s+="<tr><td>" + items[i].itemId + "</td><td>" + items[i].itemName + "</td><td>" + (items[i].itemType=='mime' ? items[i].contentType : items[i].itemType=='uri ' ? items[i].itemUriType : items[i].itemType) + "</td><td>";
		if (items[i].extents) {
			for (var j=0; j<items[i].extents.length; j++) {
				s+="[" + items[i].extents[j].extentOffset + "-" + (items[i].extents[j].extentOffset+items[i].extents[j].extentLength-1) + "]";
			}
		}
		s+="</td><td>";
		if (typeof items[i].imageWidth !== "undefined" && typeof items[i].imageHeight !== "undefined") {
			s+=items[i].imageWidth + ", " + items[i].imageHeight;
		}
		s+="</td><td>";
		if (items[i].bitsPerChannels) {
			s+="[";
			for (var j=0; j<items[i].bitsPerChannels.length; j++) {
				s+=items[i].bitsPerChannels[j];
				if (j+1<items[i].bitsPerChannels.length)
					s+=",";
			}
			s+="]";
		}
		s+="</td><td>";
		if (typeof items[i].pyramidId !== "undefined")
			s+=items[i].pyramidId;
		s+="</td><td>";
		if (typeof items[i].sizeMultiple !== "undefined")
			s+=items[i].sizeMultiple;
		s+="</td><td>";
		s+=items[i].isTile ? "yes" : "";
		s+="</td><td>";
		if (typeof items[i].tileWidth !== "undefined" && typeof items[i].tileHeight !== "undefined") {
			s+=items[i].tileWidth + ", " + items[i].tileHeight;
		}
		s+="</td><td>";
		if (typeof items[i].matrixWidth !== "undefined" && typeof items[i].matrixHeight !== "undefined") {
			s+=items[i].matrixWidth + ", " + items[i].matrixHeight;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+=items[i].tiles.length;
		}
		s+="</td><td>";
		if (items[i].tiles) {
			s+="[";
			for (var j=0; j<5 && j<items[i].tiles.length; j++) {
				s+="[" + items[i].tiles[j].offset + "-" + (items[i].tiles[j].offset+items[i].tiles[j].size-1) + "]";
				if (j+1<5 && j+1<items[i].tiles.length)
					s+=",";
				else if (j+1<items[i].tiles.length)
					s+=",...";
			}
			s+="]";
		}
		s+="</td><td>";
		if (items[i].contentId)
			s+=items[i].contentId;
		s+="</td><td>";
		if (items[i].wkt)
			s+=items[i].wkt;
		s+="</td></tr>";
	}
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

async function showGroups(groups, divId) {
	var s="<H3>Groups information</H3>";
	s+="<table border=1><tr><th>Id</th><th>Type</th><th>Tile width</th><th>Tile height</th><th>Tile matrices</th><th>Levels</th></tr>";
	for (var i=0; i<groups.length; i++) {
		s+="<tr><td>" + groups[i].groupId + "</td><td>" + groups[i].type + "</td><td>";
		if (groups[i].tileWidth)
			s+=groups[i].tileWidth;
		s+="</td><td>";
		if (groups[i].tileHeight)
			s+=groups[i].tileHeight;
		s+="</td><td>";
		if (groups[i].entities) {
			s+=groups[i].entities.length;
			s+="</td><td><table border=1><tr><th>Size multiple</th><th>Matrix widths</th><th>Matrix heights</th></tr>"
			for (var j=0; j<groups[i].entities.length; j++) {
				s+="<tr><td>"+
					groups[i].entities[j].sizeMultiple+"</td><td>"+
					groups[i].entities[j].matrixWidth+"</td><td>"+
					groups[i].entities[j].matrixHeight+"</td></tr>";
			}
			s+="</table>"
		} else
			s+="</td><td>";
		s+="</td></tr>";
	}		
	s+="</table>";
	document.getElementById(divId).innerHTML=s;
}

function preparecanvasSOHImage(canvasId, profile, width, height) {
	var s="";
	if (profile=="rgb3") {  //RGB 24 bits packed {'rgb3', 3, [{4,7},{5,7},{6,7}], 0, 1}
		s+="<canvas id=\""+canvasId+"\" width=\""+width+"px\" height=\""+height+"px\"></canvas>";
	}
	return s;
}

function showSOHImage(dataView, canvasId, profile, width, height) {
	if (profile=="rgb3") {  //RGB 24 bits packed {'rgb3', 3, [{4,7},{5,7},{6,7}], 0, 1}
		var canvas = document.getElementById(canvasId);
		var ctx = canvas.getContext('2d');

		ctx.clearRect( 0, 0, ctx.canvas.width, ctx.canvas.height);

		var imgData=ctx.createImageData(width, height);

		var data=[];
		for (var offset=0, j=0; j<height; j++) {
			for (var i=0; i<width; i++, offset+=3)
				data.push(dataView.getUint8(offset), dataView.getUint8(offset+1), dataView.getUint8(offset+2), 255)
		}

		imgData.data.set(data);

		ctx.putImageData(imgData, 0, 0);
	}
}

async function showSOHImagesItems(url, fileInfo, divId) {
	var item, s="", arrayBuffer;

	var mdat=getIndexSOHBoxType(fileInfo.boxes, "mdat");
	if (mdat==-1)
		return;
	var offsetMdat=fileInfo.boxes[mdat].start;

	var s="<H3>Item images</H3>";
	for (var a=0; a<fileInfo.items.length; a++) {
		item=fileInfo.items[a];
		if (!item.isTile) {
			if (item.tileWidth && item.tileHeight) { //is a grid or tili
				s+="<table>";
				for (var j=0; j<item.matrixHeight; j++) {
					s+="<tr>";
					for (var i=0; i<item.matrixWidth; i++) {
						if (item.itemTypeTile=="unci" && item.uncompressProfileTile=="rgb3") {
							s+="<td>Tile (" + j + "," + i + ")<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+
								preparecanvasSOHImage(item.itemId + "_" + j + "_" + i, item.uncompressProfileTile, item.tileWidth, item.tileHeight)+
								"</td>";
						}
					}
					s+="</tr>";
				}
				s+="</table>";
			}
		}
	}
	document.getElementById(divId).innerHTML=s;
	for (var a=0; a<fileInfo.items.length; a++) {
		item=fileInfo.items[a];
		if (!item.isTile) {
			if (item.tileWidth && item.tileHeight) { //is a grid or tili
				for (var j=0; j<item.matrixHeight; j++) {
					for (var i=0; i<item.matrixWidth; i++) {
						if (item.itemTypeTile=="unci" && item.uncompressProfileTile=="rgb3") {
							arrayBuffer=await getURLBuffer(url, offsetMdat+item.tiles[j*item.matrixWidth+i].offset, offsetMdat+item.tiles[j*item.matrixWidth+i].offset+item.tiles[j*item.matrixWidth+i].size-1);
							showSOHImage(new DataView(arrayBuffer), item.itemId + "_" + j + "_" + i, item.uncompressProfileTile, item.tileWidth, item.tileHeight);
						}
					}
				}
			}
		}
	}
}

	</script>
</head>

<body>
	<form>
	<!--HEIF URL: <input id="heifURL" value="tb21_4x4_grid.heif"/> sidecar: <input id="sidecarURL" value="tb21_4x4_grid.ttl"/>-->
	<!--HEIF URL: <input id="heifURL" value="rotterdam.avif"/> sidecar: <input id="sidecarURL" value=""/>-->
	HEIF URL: <input id="heifURL" value="tb21-2x4-uncompressed-internal-rdf.heif"/> sidecar: <input id="sidecarURL" value=""/>
	<button onClick='return readSOHForm("heifURL", "sidecarURL", "limit", "heifBoxes", "heifItems", "heifGroups", "images");'>read</button>
	Data max length: <input id="limit" value="20"/><br>
	<div id="heifBoxes"></div>
	<div id="heifItems"></div>
	<div id="heifGroups"></div>
	<div id="images"></div>
	</form>
</body>